generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model Level {
  id       String @id @default(nanoid())
  name     String
  imageUrl String @map("image_url")

  characters Character[]
  scores     Score[]
  sessions   Session[]

  @@map("levels")
}

model Character {
  id       String @id @default(nanoid())
  levelId  String @map("level_id")
  name     String
  imageUrl String @map("image_url")
  xPct     Float  @map("x_pct")
  yPct     Float  @map("y_pct")

  level           Level            @relation(fields: [levelId], references: [id])
  foundCharacters FoundCharacter[]

  @@index([levelId])
  @@map("characters")
}

model Score {
  id        String   @id @default(nanoid())
  levelId   String   @map("level_id")
  username  String
  scoreMs   Int      @map("score_ms")
  createdAt DateTime @default(now()) @map("created_at")

  level Level @relation(fields: [levelId], references: [id])

  @@index([levelId, scoreMs])
  @@index([createdAt])
  @@map("scores")
}

model Session {
  id        String   @id @default(nanoid())
  levelId   String   @map("level_id")
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)

  completedAt DateTime? @map("completed_at")
  timeMs      Int?      @map("time_ms")

  level           Level            @relation(fields: [levelId], references: [id])
  foundCharacters FoundCharacter[]

  @@map("sessions")
}

model FoundCharacter {
  id          String   @id @default(nanoid())
  sessionId   String   @map("session_id")
  characterId String   @map("character_id")
  foundAt     DateTime @default(now()) @map("found_at")

  session   Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  character Character @relation(fields: [characterId], references: [id])

  @@unique([sessionId, characterId])
  @@map("found_characters")
}
